{%- assign product_form_id = product_form_id | default: 'product-form' -%}

<product-form class="product-form">
  <div class="product-form__error-message-wrapper" role="alert" hidden>
    <h2 class="form__message" tabindex="-1" autofocus>
      <span class="visually-hidden">{{ 'accessibility.error' | t }} </span>
      {% render 'icon-error' %}
      <span class="product-form__error-message"></span>
    </h2>
  </div>

  {%- form 'product', product, id: product_form_id, class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
    <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" disabled>
    
    <div class="product-form__buttons">
      {%- liquid
        assign check_against_inventory = true
        if product.selected_or_first_available_variant.inventory_management != 'shopify' or  product.selected_or_first_available_variant.inventory_policy == 'continue'
          assign check_against_inventory = false
        endif
        if product.selected_or_first_available_variant.quantity_rule.min > product.selected_or_first_available_variant.inventory_quantity and check_against_inventory
          assign quantity_rule_soldout = true
        endif
      -%}

      <div class="product-form__cart-submit">
        <button
          type="submit"
          name="add"
          class="product-form__cart-submit-button button button--full-width{% if horizontal_quick_add %} button--secondary{% else %} button--primary{% endif %}"
          {% if product.selected_or_first_available_variant.available == false or quantity_rule_soldout %}disabled{% endif %}
          aria-describedby="cart-notification-button-{{ section_id }}"
        >
          <span>
            {%- if product.selected_or_first_available_variant.available == false or quantity_rule_soldout -%}
              {{ 'products.product.sold_out' | t }}
            {%- else -%}
              {{ 'products.product.add_to_cart' | t }}
            {%- endif -%}
          </span>
          <div class="loading-overlay__spinner hidden">
            <svg
              aria-hidden="true"
              focusable="false"
              class="spinner"
              viewBox="0 0 66 66"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle
                class="path"
                fill="none"
                stroke-width="6"
                cx="33"
                cy="33"
                r="30"
              ></circle>
            </svg>
          </div>
        </button>
        {%- if show_dynamic_checkout -%}
          {{ form | payment_button }}
        {%- endif -%}
      </div>
    </div>
  {%- endform -%}
</product-form>

{%- if gift_card_recipient_feature_active and product.gift_card? -%}
  {%- render 'gift-card-recipient-form', product: product, form: form, section: section -%}
{%- endif -%}

<script src="{{ 'pickup-availability.js' | asset_url }}" defer="defer"></script>

{%- if show_pickup_availability -%}
  {{ 'component-pickup-availability.css' | asset_url | stylesheet_tag }}

  {%- assign pick_up_availabilities = product.selected_or_first_available_variant.store_availabilities | where: 'pick_up_enabled', true -%}

  <pickup-availability
    class="product__pickup-availabilities no-js-hidden quick-add-hidden"
    {% if product.selected_or_first_available_variant.available and pick_up_availabilities.size > 0 %}
      available
    {% endif %}
    data-root-url="{{ routes.root_url }}"
    data-variant-id="{{ product.selected_or_first_available_variant.id }}"
    data-has-only-default-variant="{{ product.has_only_default_variant }}"
    data-product-page-color-scheme="gradient color-{{ section.settings.color_scheme }}"
  >
    <template>
      <pickup-availability-preview class="pickup-availability-preview">
        {% render 'icon-unavailable' %}
        <div class="pickup-availability-info">
          <p class="caption-large">{{ 'products.product.pickup_availability.unavailable' | t }}</p>
          <button class="pickup-availability-button link link--text underlined-link">
            {{ 'products.product.pickup_availability.refresh' | t }}
          </button>
        </div>
      </pickup-availability-preview>
    </template>
  </pickup-availability>

  <script src="{{ 'pickup-availability.js' | asset_url }}" defer="defer"></script>
{%- endif -%}